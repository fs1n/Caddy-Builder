name: Check for Caddy and Plugin Updates

on:
  schedule:
    # Check for updates daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write  # Needed for committing version file
  actions: write  # Needed for triggering workflows

jobs:
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Check Caddy version
        id: check_caddy
        run: |
          # Get latest Caddy version from GitHub
          LATEST_CADDY=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | jq -r .tag_name)
          echo "latest_version=$LATEST_CADDY" >> $GITHUB_OUTPUT
          echo "Latest Caddy version: $LATEST_CADDY"

          # Check if we have a previous version file
          if [ -f .caddy-version ]; then
            CURRENT_CADDY=$(cat .caddy-version)
            echo "current_version=$CURRENT_CADDY" >> $GITHUB_OUTPUT
            echo "Current Caddy version: $CURRENT_CADDY"

            if [ "$LATEST_CADDY" != "$CURRENT_CADDY" ]; then
              echo "update_available=true" >> $GITHUB_OUTPUT
              echo "Caddy update available: $CURRENT_CADDY -> $LATEST_CADDY"
            else
              echo "update_available=false" >> $GITHUB_OUTPUT
              echo "Caddy is up to date"
            fi
          else
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "No version tracking file found, will create one"
          fi

      - name: Check plugin updates
        id: check_plugins
        run: |
          if [ ! -f plugins.txt ]; then
            echo "No plugins.txt file found"
            echo "plugins_update_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PLUGINS_CHANGED=false

          # Read each plugin and check for updates
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines and comments
            if [ -z "$line" ] || [ "${line:0:1}" = "#" ]; then
              continue
            fi

            echo "Checking plugin: $line"

            # Extract owner and repo from github.com/owner/repo format
            if [[ $line =~ github\.com/([^/]+)/([^/]+) ]]; then
              OWNER="${BASH_REMATCH[1]}"
              REPO="${BASH_REMATCH[2]}"

              # Get latest commit or release
              LATEST_INFO=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main" 2>/dev/null || \
                           curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/master" 2>/dev/null || \
                           echo "")

              if [ -n "$LATEST_INFO" ]; then
                LATEST_SHA=$(echo "$LATEST_INFO" | jq -r .sha 2>/dev/null || echo "")
                if [ -n "$LATEST_SHA" ]; then
                  echo "  Latest commit: ${LATEST_SHA:0:7}"
                fi
              fi
            fi
          done < plugins.txt

          # For simplicity, we'll trigger builds weekly or on plugin file changes
          # More sophisticated plugin version tracking can be added later
          echo "plugins_update_available=false" >> $GITHUB_OUTPUT

      - name: Update version file
        if: steps.check_caddy.outputs.update_available == 'true'
        run: |
          echo "${{ steps.check_caddy.outputs.latest_version }}" > .caddy-version
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .caddy-version
          git commit -m "Update Caddy version to ${{ steps.check_caddy.outputs.latest_version }}" || true
          git push || true

      - name: Trigger build workflow
        if: steps.check_caddy.outputs.update_available == 'true'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-caddy.yml/dispatches \
            -d '{"ref":"${{ github.ref_name }}"}'

      - name: Create update notification
        if: steps.check_caddy.outputs.update_available == 'true'
        run: |
          echo "::notice::Caddy update detected: ${{ steps.check_caddy.outputs.current_version }} -> ${{ steps.check_caddy.outputs.latest_version }}"
          echo "Build workflow triggered automatically"
